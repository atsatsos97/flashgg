* flashgg

** Introduction
   The basic instructions to setup and run flashgg are described here and in corresponding READMEs 
   in subdirectories of the repository.

   If you get stuck or have questions, please first consult the FAQs page [[https://cms-analysis.github.io/flashgg/][here]].
   
** Flashgg setup for the very low mass analysis in CMSSW_10_6_8:
   Get flashgg:
   #+BEGIN_EXAMPLE
   export SCRAM_ARCH=slc7_amd64_gcc700
   cmsrel CMSSW_10_6_8
   cd CMSSW_10_6_8/src/
   cmsenv
   git cms-init  
   git clone -b lowMass_106X_2018UL https://github.com/elfontan/flashgg
   source flashgg/setup_flashgg.sh 
   cd flashgg/
   cd ../
   scram b -j 8
   #+END_EXAMPLE

** Examples to run on Run 2 2018 UL sample:
 * Manual test for microAOD production with a single file:
   #+BEGIN_EXAMPLE
   cmsRun MicroAOD/test/microAODstd.py processType=[sig] datasetName=glugluh conditionsJSON=MetaData/data/MetaConditions/Era2018_UL_lowMassDiphotonAnalysis.json
   #+END_EXAMPLE
   
 * MicroAOD step on a dataset (note that you need a proper json file in the =campaign= directory):
   #+BEGIN_EXAMPLE
   ./prepareCrabJobs.py -V v0 -C analysisLM_UL18 --meta-conditions /afs/cern.ch/work/e/elfontan/private/DiPhotonAnalysis/myFlashGG/CMSSW_10_6_8/src/flashgg/MetaData/data/MetaConditions/Era2018_UL_lowMassDiphotonAnalysis.json  -O T2_US_MIT -o /store/user/elfontan -s campaigns/TEST_M70_UL.json --mkPilot
   #+END_EXAMPLE

   The jobs can be submitted and monitored with this kind of commands:
   #+BEGIN_EXAMPLE
   echo pilot_*.py | xargs -n 1 crab submit                       ## it will submit the pilot test crab jobs
   echo crabConfig_v0_GluGluHToGG_M*.py | xargs -n 1 crab submit  ## submission of the signal jobs
   echo crab_v0_GluGluHToGG_M* | xargs -n 1 crab status           ## to check the status of the jobs
   #+END_EXAMPLE

   The output is located in DAS in the =prod/phys03= database in the form:
   #+BEGIN_EXAMPLE
   /GluGluHToGG_M70_TuneCP5_13TeV-amcatnloFXFX-pythia8/elfontan-analysisLM_UL18-v0-v0-RunIISummer20UL18MiniAODv2-106X_upgrade2018_realistic_v16_L1v1-v1-82689a8dd9f3f8660dbba0021defef47/USER
   #+END_EXAMPLE

 * Flashgg step:
   
   First you need to create a catalogue for the newly produced dataset. From the =flashgg= directory, run
   #+BEGIN_EXAMPLE
   fggManageSamples.py -C analysisLM_new_UL18 import '/GluGluHToGG_M*/elfontan-analysisLM_new_UL18*/USER'

   #+END_EXAMPLE
   The output will be located in a subdirectory of =MetaData/data= with the same name of the campaign, e.g.:
   #+BEGIN_EXAMPLE
   /afs/cern.ch/work/e/elfontan/private/DiPhotonAnalysis/myFlashGG/CMSSW_10_6_8/src/flashgg/MetaData/data/analysisLM_new_UL18/datasets.json 
   #+END_EXAMPLE   

   Finally, you can launch your jobs to produce the final miniTrees.
   *Note: copying the proxy file to the working node is not yet supported when using HTCondor as bacth system. Therefore the user must set*
   *the =X509_USER_PROXY= environment variable and run with the =--no-copy-proxy= option*
   #+BEGIN_EXAMPLE
   cd Systematics/test
   voms-proxy-init -voms cms --valid 168:00
   cp /tmp/MYPROXY ~/
   export X509_USER_PROXY=~/MYPROXY
   fggRunJobs.py --load analysisLM_new_UL18.json -d outdir_analysisLM_new_UL18 workspaceStd.py -n 300 -q workday --no-copy-proxy --no-use-tarball
   #+END_EXAMPLE 

